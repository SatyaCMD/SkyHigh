{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Trips | SkyHigh</title>
    <link rel="icon" href="{% static 'img/favicon.png' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#B91C1C',
                        secondary: '#B45309',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Outfit"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=2074&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .trip-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .trip-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .trip-card.upcoming {
            border-left-color: #B91C1C;
        }

        .trip-card.completed {
            border-left-color: #64748b;
            opacity: 0.8;
        }

        .trip-card.cancelled {
            border-left-color: #ef4444;
            opacity: 0.7;
            background: #fef2f2;
        }
    </style>
</head>

<body class="font-sans text-black antialiased min-h-screen flex flex-col">
    <nav class="bg-white/95 backdrop-blur-md shadow-md fixed w-full z-50 transition-all duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 text-2xl font-serif font-bold text-primary">
                <i class="fas fa-plane-departure"></i> SkyHigh
            </div>
            <div class="hidden md:flex items-center gap-8 font-medium text-black">
                <a href="/" class="hover:text-primary transition-colors font-bold">Book Flight</a>
                <a href="/my-trips/" class="text-primary font-bold">My Trips</a>
                <a href="/check-in/" class="hover:text-primary transition-colors font-bold">Check-in</a>
                <a href="/profile/"
                    class="profile-link hidden hover:text-primary transition-colors font-bold">Dashboard</a>
                <a href="/login/"
                    class="login-btn bg-primary text-white px-6 py-2 rounded-full hover:bg-red-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-bold">Login</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-32">
        <div class="glass-panel max-w-5xl mx-auto p-8 rounded-3xl relative overflow-hidden min-h-[600px]">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-secondary"></div>

            <a href="/" class="mb-4 inline-block text-primary hover:text-red-700 transition-colors font-bold text-lg"><i
                    class="fas fa-arrow-left mr-2"></i> Back to Home</a>
            <div class="flex justify-between items-center mb-8">
                <h1 class="font-serif text-3xl font-bold text-black">My Journeys</h1>
                <div class="flex gap-2">
                    <button
                        class="px-4 py-2 rounded-full bg-red-50 text-primary font-bold text-sm hover:bg-red-100 transition-colors active">All</button>
                    <button
                        class="px-4 py-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold text-sm transition-colors">Upcoming</button>
                    <button
                        class="px-4 py-2 rounded-full hover:bg-gray-100 text-gray-600 font-bold text-sm transition-colors">Completed</button>
                </div>
            </div>

            <div id="trips-container" class="space-y-4">
                <div class="text-center py-12">
                    <div
                        class="spinner border-4 border-primary border-t-transparent w-12 h-12 rounded-full animate-spin mx-auto">
                    </div>
                    <p class="mt-4 text-gray-500 font-medium">Loading your journeys...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white/95 backdrop-blur-md border-t border-gray-200 py-8 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <div class="flex justify-center gap-8 mb-4 text-gray-600 font-medium">
                <a href="/about/" class="hover:text-primary transition-colors">About Us</a>
                <a href="/contact/" class="hover:text-primary transition-colors">Contact</a>
                <a href="/privacy/" class="hover:text-primary transition-colors">Privacy Policy</a>
                <a href="/terms/" class="hover:text-primary transition-colors">Terms of Service</a>
            </div>
            <div class="text-gray-500 text-sm font-bold">
                &copy; 2026 SkyHigh Airlines. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="{% static 'js/app.js' %}"></script>
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('trips-container');
            const userStr = localStorage.getItem('user');
            const filterBtns = document.querySelectorAll('.flex.gap-2 button');

            if (!userStr) {
                window.location.href = '/login/';
                return;
            }

            const user = JSON.parse(userStr);
            let allBookings = [];

            try {
                const response = await fetch(`/api/flights/bookings/?email=${user.email}`);
                allBookings = await response.json();
                renderTrips(allBookings);
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="text-center text-red-500 font-bold">Failed to load trips.</div>';
            }

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => {
                        b.classList.remove('bg-red-50', 'text-primary');
                        b.classList.add('text-gray-600', 'hover:bg-gray-100');
                    });
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    btn.classList.add('bg-red-50', 'text-primary');

                    const filter = btn.textContent.trim().toLowerCase();
                    let filtered = allBookings;

                    if (filter === 'upcoming') {
                        filtered = allBookings.filter(b => {
                            const date = (b.flight_details && b.flight_details.departure_time)
                                ? new Date(b.flight_details.departure_time)
                                : new Date(b.booking_date);
                            return date >= new Date() && b.status !== 'Cancelled';
                        });
                    } else if (filter === 'completed') {
                        filtered = allBookings.filter(b => {
                            const date = (b.flight_details && b.flight_details.departure_time)
                                ? new Date(b.flight_details.departure_time)
                                : new Date(b.booking_date);
                            return date < new Date() && b.status !== 'Cancelled';
                        });
                    }

                    renderTrips(filtered);
                });
            });

            function renderTrips(bookings) {
                container.innerHTML = '';

                if (bookings.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16">
                            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-suitcase-rolling text-4xl text-gray-400"></i>
                            </div>
                            <h3 class="text-xl font-bold text-black mb-2">No trips found</h3>
                            <p class="text-gray-500 mb-8">You haven't booked any flights yet.</p>
                            <a href="/" class="bg-primary text-white px-8 py-3 rounded-full font-bold hover:bg-red-700 transition-all shadow-lg">Book a Flight</a>
                        </div>
                    `;
                    return;
                }

                bookings.forEach(booking => {
                    const card = document.createElement('div');
                    const isCancelled = booking.status === 'Cancelled';
                    const flightDate = (booking.flight_details && booking.flight_details.departure_time)
                        ? new Date(booking.flight_details.departure_time)
                        : new Date(booking.booking_date);

                    const isCompleted = flightDate < new Date() && !isCancelled;
                    const statusClass = isCancelled ? 'cancelled' : (isCompleted ? 'completed' : 'upcoming');

                    let origin = '---';
                    let destination = '---';

                    if (booking.flight_details && booking.flight_details.origin) {
                        origin = booking.flight_details.origin;
                    } else if (booking.origin) {
                        origin = booking.origin;
                    }

                    if (booking.flight_details && booking.flight_details.destination) {
                        destination = booking.flight_details.destination;
                    } else if (booking.destination) {
                        destination = booking.destination;
                    }

                    card.className = `trip-card ${statusClass}`;

                    card.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div class="flex-grow">
                                <div class="flex items-center gap-4 mb-2">
                                    <span class="bg-red-50 text-primary px-3 py-1 rounded-md text-sm font-bold font-mono tracking-wide">${booking.flight_number}</span>
                                    <span class="text-sm font-bold text-gray-500">${new Date(booking.booking_date).toLocaleDateString()}</span>
                                    ${isCancelled ? '<span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold uppercase">Cancelled</span>' : ''}
                                </div>
                                <div class="flex items-center gap-8">
                                    <div>
                                        <div class="text-2xl font-serif font-bold text-black">${origin}</div>
                                        <div class="text-xs text-gray-500 font-bold uppercase tracking-wider">Origin</div>
                                    </div>
                                    <div class="text-gray-300">
                                        <i class="fas fa-plane text-xl"></i>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-serif font-bold text-black">${destination}</div>
                                        <div class="text-xs text-gray-500 font-bold uppercase tracking-wider">Destination</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2 min-w-[150px]">
                                <div class="text-right">
                                    <div class="text-sm text-gray-500 font-bold">Booking Ref</div>
                                    <div class="font-mono text-lg font-bold text-black">${booking.booking_reference}</div>
                                </div>
                                <div class="flex gap-2 justify-end mt-2">
                                    ${!isCancelled ? `
                                        <a href="/api/flights/bookings/receipt/${booking.booking_reference}/download/" target="_blank" class="p-2 text-gray-400 hover:text-primary transition-colors" title="Download Receipt">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>
                                        <button onclick="viewTicket('${booking.booking_reference}')" class="p-2 text-gray-400 hover:text-primary transition-colors" title="View Ticket">
                                            <i class="fas fa-ticket-alt"></i>
                                        </button>
                                        <button onclick="cancelBooking('${booking.booking_reference}')" class="p-2 text-gray-400 hover:text-red-600 transition-colors" title="Cancel Booking">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        });

        function viewTicket(ref) {
            window.location.href = `/api/flights/bookings/ticket/${ref}/`;
        }

        async function cancelBooking(ref) {
            if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/flights/bookings/cancel/${ref}/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('Booking cancelled successfully.');
                    window.location.reload();
                } else {
                    alert('Failed to cancel booking.');
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred.');
            }
        }
    </script>
</body>

</html>
