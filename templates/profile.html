<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | SkyHigh</title>
    <link rel="icon" href="{% static 'img/favicon.png' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#B91C1C',
                        secondary: '#B45309',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Outfit"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=2074&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .stat-card {
            background: #f8fafc;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #B91C1C;
        }

        .gold-card {
            background: linear-gradient(135deg, #B45309 0%, #fbbf24 50%, #B45309 100%);
            color: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(180, 83, 9, 0.4);
            position: relative;
            overflow: hidden;
        }

        .gold-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.1;
        }
    </style>
</head>

<body class="font-sans text-black antialiased min-h-screen flex flex-col">
    <nav class="bg-white/95 backdrop-blur-md shadow-md fixed w-full z-50 transition-all duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 text-2xl font-serif font-bold text-primary">
                <i class="fas fa-plane-departure"></i> SkyHigh
            </div>
            <div class="hidden md:flex items-center gap-8 font-medium text-black nav-links">
                <a href="/" class="hover:text-primary transition-colors font-bold">Book Flight</a>
                <a href="/my-trips/" class="hover:text-primary transition-colors font-bold">My Trips</a>
                <a href="/check-in/" class="hover:text-primary transition-colors font-bold">Check-in</a>
                <a href="/profile/" class="text-primary font-bold">Dashboard</a>
                <a href="/login/"
                    class="login-btn bg-primary text-white px-6 py-2 rounded-full hover:bg-red-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-bold">Login</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-32">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-panel p-8 rounded-3xl text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-primary to-secondary"></div>
                    <div class="relative">
                        <div class="w-24 h-24 bg-white rounded-full p-1 mx-auto mb-4 shadow-lg">
                            <div
                                class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-3xl text-gray-400 overflow-hidden">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        <h2 class="font-serif text-2xl font-bold text-black mb-1" id="profile-name">Loading...</h2>
                        <p class="text-gray-500 font-medium mb-4" id="profile-email">...</p>
                        <div
                            class="inline-flex items-center gap-2 px-4 py-1.5 bg-yellow-50 text-yellow-700 rounded-full text-sm font-bold border border-yellow-200">
                            <i class="fas fa-crown"></i> Gold Member
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-3xl">
                    <nav class="space-y-1">
                        <a href="/"
                            class="flex items-center gap-4 px-6 py-4 text-gray-600 hover:bg-gray-50 hover:text-black rounded-xl font-bold transition-colors">
                            <i class="fas fa-arrow-left w-6"></i> Back to Home
                        </a>
                        <a href="#"
                            class="flex items-center gap-4 px-6 py-4 bg-red-50 text-primary rounded-xl font-bold transition-colors">
                            <i class="fas fa-chart-pie w-6"></i> Dashboard
                        </a>
                        <a href="/my-trips/"
                            class="flex items-center gap-4 px-6 py-4 text-gray-600 hover:bg-gray-50 hover:text-black rounded-xl font-bold transition-colors">
                            <i class="fas fa-plane w-6"></i> My Trips
                        </a>
                        <button onclick="openSettings()"
                            class="w-full flex items-center gap-4 px-6 py-4 text-gray-600 hover:bg-gray-50 hover:text-black rounded-xl font-bold transition-colors">
                            <i class="fas fa-cog w-6"></i> Settings
                        </button>
                        <button onclick="confirmLogout()"
                            class="w-full flex items-center gap-4 px-6 py-4 text-red-600 hover:bg-red-50 rounded-xl font-bold transition-colors mt-4">
                            <i class="fas fa-sign-out-alt w-6"></i> Logout
                        </button>
                    </nav>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="gold-card">
                    <div class="flex justify-between items-start mb-8 relative z-10">
                        <div>
                            <div class="text-white/80 text-sm font-bold uppercase tracking-wider mb-1">Membership ID
                            </div>
                            <div class="font-mono text-2xl font-bold tracking-widest" id="membership-id">.... .... ....
                            </div>
                        </div>
                        <div class="text-4xl opacity-80"><i class="fas fa-plane-departure"></i></div>
                    </div>
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <div class="text-white/80 text-sm font-bold uppercase tracking-wider mb-1">Member Since
                            </div>
                            <div class="font-bold text-lg">Dec 2024</div>
                        </div>
                        <div class="text-right">
                            <div class="text-white/80 text-sm font-bold uppercase tracking-wider mb-1">Status</div>
                            <div class="font-bold text-lg">Active</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="stat-card">
                        <div class="flex items-center gap-4 mb-2">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                <i class="fas fa-plane-departure"></i>
                            </div>
                            <h3 class="font-bold text-gray-500 uppercase text-sm">Total Flights</h3>
                        </div>
                        <p class="text-3xl font-serif font-bold text-black" id="total-flights">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center gap-4 mb-2">
                            <div
                                class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
                                <i class="fas fa-globe-americas"></i>
                            </div>
                            <h3 class="font-bold text-gray-500 uppercase text-sm">Next Trip</h3>
                        </div>
                        <p class="text-xl font-serif font-bold text-black truncate" id="next-trip">No upcoming trips</p>
                    </div>
                </div>

                <div class="glass-panel p-8 rounded-3xl">
                    <h3 class="font-serif text-2xl font-bold text-black mb-6">Recent Activity</h3>
                    <div class="space-y-6">
                        <div class="flex items-center gap-4 pb-6 border-b border-gray-100">
                            <div
                                class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-black">Profile Updated</h4>
                                <p class="text-sm text-gray-500">Your account details were updated successfully.</p>
                            </div>
                            <span class="ml-auto text-sm text-gray-400 font-bold">Just now</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="settings-modal"
        class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl relative">
            <button onclick="closeSettings()"
                class="absolute top-4 right-4 text-gray-400 hover:text-black w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="font-serif text-2xl font-bold text-black mb-6">Account Settings</h3>
            <form class="space-y-4">
                <div>
                    <label class="block text-black font-bold mb-2 text-sm">Display Name</label>
                    <input type="text" id="settings-name"
                        class="w-full p-3 border rounded-xl bg-gray-50 focus:border-primary focus:outline-none font-medium">
                </div>
                <div>
                    <label class="block text-black font-bold mb-2 text-sm">Email Preferences</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" checked class="w-5 h-5 text-primary rounded focus:ring-primary">
                            <span class="text-gray-600 font-medium">Flight updates & reminders</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 text-primary rounded focus:ring-primary">
                            <span class="text-gray-600 font-medium">Marketing & offers</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-black font-bold mb-2 text-sm">Change Password</label>
                    <input type="password" id="new-password" placeholder="Leave blank to keep current"
                        class="w-full p-3 border rounded-xl bg-gray-50 focus:border-primary focus:outline-none font-medium">
                </div>
                <div class="pt-4 border-t border-gray-100">
                    <button type="button" onclick="confirmDeleteAccount()"
                        class="w-full py-3 text-red-600 font-bold hover:bg-red-50 rounded-xl transition-colors">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Account
                    </button>
                </div>
                <button type="button" onclick="saveSettings()"
                    class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:bg-red-700 transition-colors mt-4">Save
                    Changes</button>
            </form>
        </div>
    </div>

    <div id="logout-modal"
        class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-sm p-8 rounded-3xl text-center">
            <div
                class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 text-red-600 text-2xl">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3 class="font-serif text-2xl font-bold text-black mb-2">Sign Out?</h3>
            <p class="text-gray-500 font-medium mb-8">Are you sure you want to end your session?</p>
            <div class="flex gap-4">
                <button onclick="closeLogout()"
                    class="flex-1 py-3 rounded-xl border-2 border-gray-200 font-bold text-gray-600 hover:bg-gray-50 transition-colors">Cancel</button>
                <button onclick="performLogout()"
                    class="flex-1 py-3 rounded-xl bg-primary text-white font-bold hover:bg-red-700 transition-colors shadow-lg">Logout</button>
            </div>
        </div>
    </div>

    <div id="delete-account-modal"
        class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-sm p-8 rounded-3xl text-center">
            <div
                class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 text-red-600 text-2xl">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="font-serif text-2xl font-bold text-black mb-2">Delete Account?</h3>
            <p class="text-gray-500 font-medium mb-8">This action cannot be undone. All your data will be permanently
                removed.</p>
            <div class="flex gap-4">
                <button onclick="closeDeleteAccount()"
                    class="flex-1 py-3 rounded-xl border-2 border-gray-200 font-bold text-gray-600 hover:bg-gray-50 transition-colors">Cancel</button>
                <button onclick="performDeleteAccount()"
                    class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-colors shadow-lg">Delete</button>
            </div>
        </div>
    </div>

    <footer class="bg-white/95 backdrop-blur-md border-t border-gray-200 py-8 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <div class="flex justify-center gap-8 mb-4 text-gray-600 font-medium">
                <a href="/about/" class="hover:text-primary transition-colors">About Us</a>
                <a href="/contact/" class="hover:text-primary transition-colors">Contact</a>
                <a href="/privacy/" class="hover:text-primary transition-colors">Privacy Policy</a>
                <a href="/terms/" class="hover:text-primary transition-colors">Terms of Service</a>
            </div>
            <div class="text-gray-500 text-sm font-bold">
                &copy; 2026 SkyHigh Airlines. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="{% static 'js/app.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login/';
                return;
            }

            const user = JSON.parse(userStr);
            document.getElementById('profile-name').textContent = user.name || 'Valued Member';
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('membership-id').textContent = user.membership_id || 'SH-0000-0000';

            try {
                const res = await fetch(`/api/flights/user/stats/?email=${user.email}`);
                const stats = await res.json();
                document.getElementById('total-flights').textContent = stats.total_flights || 0;

                if (stats.next_trip) {
                    const date = new Date(stats.next_trip.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                    document.getElementById('next-trip').textContent = `${stats.next_trip.destination} â€¢ ${date}`;
                }
            } catch (e) {
                console.error("Failed to fetch stats", e);
            }
        });

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function confirmLogout() {
            document.getElementById('logout-modal').classList.remove('hidden');
        }
        function closeLogout() {
            document.getElementById('logout-modal').classList.add('hidden');
        }
        async function saveSettings() {
            const userStr = localStorage.getItem('user');
            if (!userStr) return;

            const user = JSON.parse(userStr);
            const newName = document.getElementById('settings-name').value;
            const newPassword = document.getElementById('new-password').value;

            const payload = {
                email: user.email,
                name: newName
            };

            if (newPassword) {
                payload.password = newPassword;
            }

            try {
                const res = await fetch('/api/flights/auth/update-profile/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    document.getElementById('profile-name').textContent = data.user.name;
                    closeSettings();
                    alert('Profile updated successfully');
                } else {
                    alert(data.error || 'Failed to update profile');
                }
            } catch (e) {
                console.error('Error updating profile:', e);
                alert('An error occurred while updating profile');
            }
        }

        function confirmDeleteAccount() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('delete-account-modal').classList.remove('hidden');
        }

        function closeDeleteAccount() {
            document.getElementById('delete-account-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        async function performDeleteAccount() {
            const userStr = localStorage.getItem('user');
            if (!userStr) return;

            const user = JSON.parse(userStr);

            try {
                const res = await fetch('/api/flights/auth/delete-account/', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: user.email })
                });

                if (res.ok) {
                    localStorage.removeItem('user');
                    window.location.href = '/login/';
                } else {
                    const data = await res.json();
                    alert(data.error || 'Failed to delete account');
                }
            } catch (e) {
                console.error('Error deleting account:', e);
                alert('An error occurred while deleting account');
            }
        }

        function performLogout() {
            localStorage.removeItem('user');
            window.location.href = '/login/';
        }
    </script>
</body>

</html>
