<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Booking | SkyHigh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css?v=3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link id="favicon" rel="icon" href="/static/img/favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#B91C1C',
                        secondary: '#B45309',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Outfit"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        .step-active {
            color: #B91C1C;
            border-color: #B91C1C;
            background-color: #FEF2F2;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .seat {
            width: 40px;
            height: 40px;
            margin: 4px;
            border-radius: 8px;
            background-color: #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            position: relative;
        }

        .seat:hover:not(.occupied):not(.disabled) {
            background-color: #cbd5e1;
            transform: scale(1.1);
        }

        .seat.occupied {
            background-color: #fee2e2;
            color: #ef4444;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .seat.occupied::after {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            font-size: 14px;
        }

        .seat.selected {
            background-color: #B91C1C;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(185, 28, 28, 0.3);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .seat.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: #f1f5f9;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .aisle {
            width: 20px;
        }

        @keyframes pop-in {
            0% {
                transform: scale(0.8);
            }

            100% {
                transform: scale(1.1);
            }
        }
    </style>
</head>

<body class="font-sans text-gray-800 antialiased">
    <nav class="glass-panel fixed w-full z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2 text-2xl font-serif font-bold text-primary">
                <i class="fas fa-plane-departure"></i>
                SkyHigh
            </div>
            <div class="hidden md:flex items-center gap-8 font-medium text-gray-600">
                <a href="/" class="hover:text-primary transition-colors">Book Flight</a>
                <a href="/my-trips/" class="hover:text-primary transition-colors">My Trips</a>
                <a href="/check-in/" class="hover:text-primary transition-colors">Check-in</a>
                <a href="/profile/" class="profile-link hidden hover:text-primary transition-colors">Profile</a>
                <a href="/login/"
                    class="login-btn bg-primary text-white px-6 py-2 rounded-full hover:bg-red-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Login</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-28 pb-16 max-w-7xl">
        <a href="/" class="mb-4 inline-block text-primary hover:text-red-700 transition-colors font-bold text-lg">
            <i class="fas fa-arrow-left mr-2"></i>Back to Home
        </a>

        <div class="flex items-center justify-center mb-12 max-w-4xl mx-auto">
            <div class="flex items-center gap-3 text-primary font-bold">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center border-2 border-primary">
                    <i class="fas fa-check"></i>
                </div>
                <span class="hidden sm:inline">Flight</span>
            </div>
            <div class="h-1 flex-1 bg-gray-200 mx-4 rounded-full"></div>
            <div class="flex items-center gap-3 text-gray-400 font-medium" data-step="passengers">
                <div
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center border-2 border-gray-200">
                    <i class="fas fa-user"></i>
                </div>
                <span class="hidden sm:inline">Passengers</span>
            </div>
            <div class="h-1 flex-1 bg-gray-200 mx-4 rounded-full"></div>
            <div class="flex items-center gap-3 text-gray-400 font-medium" data-step="seats">
                <div
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center border-2 border-gray-200">
                    <i class="fas fa-couch"></i>
                </div>
                <span class="hidden sm:inline">Seats</span>
            </div>
            <div class="h-1 flex-1 bg-gray-200 mx-4 rounded-full"></div>
            <div class="flex items-center gap-3 text-gray-400 font-medium" data-step="payment">
                <div
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center border-2 border-gray-200">
                    <i class="fas fa-credit-card"></i>
                </div>
                <span class="hidden sm:inline">Payment</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <form id="booking-form" class="space-y-8">
                    <div id="flight-options-section" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-sliders-h text-secondary"></i>Flight Options
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="block text-gray-700 font-medium mb-3 text-lg">Trip Type</label>
                                <div class="flex gap-4">
                                    <label class="cursor-pointer relative group flex-1">
                                        <input type="radio" name="trip_type" value="one_way" checked
                                            class="peer absolute opacity-0">
                                        <div
                                            class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-red-50 transition-all flex flex-col items-center justify-center gap-2 h-full group-hover:border-gray-300">
                                            <i
                                                class="fas fa-arrow-right text-xl text-gray-400 peer-checked:text-primary"></i>
                                            <span
                                                class="text-sm font-medium text-gray-600 peer-checked:text-primary">One
                                                Way</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative group flex-1">
                                        <input type="radio" name="trip_type" value="round_trip"
                                            class="peer absolute opacity-0">
                                        <div
                                            class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-red-50 transition-all flex flex-col items-center justify-center gap-2 h-full group-hover:border-gray-300">
                                            <i
                                                class="fas fa-exchange-alt text-xl text-gray-400 peer-checked:text-primary"></i>
                                            <span
                                                class="text-sm font-medium text-gray-600 peer-checked:text-primary">Round
                                                Trip</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group hidden" id="return-date-container">
                                <label class="block text-gray-700 font-medium mb-3 text-lg">Return Date</label>
                                <input type="date" id="return-date" name="return_date"
                                    class="w-full p-4 text-lg bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                            </div>
                        </div>
                        <div class="form-group mt-6">
                            <label class="block text-gray-700 font-medium mb-3 text-lg">Travel Class</label>
                            <div class="relative">
                                <select id="travel-class" name="travel_class"
                                    class="w-full p-4 text-lg bg-gray-50 border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors appearance-none cursor-pointer">
                                    <option value="Economy">Economy (1x Fare)</option>
                                    <option value="Business">Business (1.5x Fare)</option>
                                    <option value="First">First Class (2.5x Fare)</option>
                                </select>
                                <div
                                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="passengers-section" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-users text-secondary"></i>Passenger Details
                        </h2>
                        <div id="passengers-container" class="space-y-6"></div>
                        <button type="button" id="add-passenger-btn"
                            class="w-full mt-6 py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-medium hover:border-primary hover:text-primary hover:bg-red-50 transition-all flex items-center justify-center gap-2 group">
                            <i class="fas fa-plus group-hover:rotate-90 transition-transform"></i>Add Another Passenger
                        </button>
                        <button type="button" id="confirm-passengers-btn"
                            class="w-full mt-4 bg-primary hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg transform transition hover:-translate-y-0.5">
                            Confirm Passengers & Select Seats
                        </button>
                    </div>

                    <div id="seat-selection-section"
                        class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-couch text-secondary"></i>Select Your Seats
                        </h2>
                        <div id="seat-map-container" class="w-full mx-auto"></div>
                        <button type="button" id="confirm-seats-btn"
                            class="w-full mt-4 bg-primary hover:bg-red-700 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg transform transition hover:-translate-y-0.5">
                            Confirm Seats & Proceed to Payment
                        </button>
                    </div>

                    <div id="payment-section" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                            <i class="fas fa-wallet text-secondary"></i>Payment
                        </h2>
                        <div class="mb-8">
                            <label class="block text-gray-700 font-medium mb-4 text-lg">Select Payment Method</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="payment_method" value="card" checked
                                        class="peer absolute opacity-0">
                                    <div
                                        class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-red-50 transition-all flex flex-col items-center justify-center gap-2 h-full group-hover:border-gray-300">
                                        <i
                                            class="fas fa-credit-card text-2xl text-gray-400 peer-checked:text-primary"></i>
                                        <span
                                            class="text-sm font-medium text-gray-600 peer-checked:text-primary">Card</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="payment_method" value="upi"
                                        class="peer absolute opacity-0">
                                    <div
                                        class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-red-50 transition-all flex flex-col items-center justify-center gap-2 h-full group-hover:border-gray-300">
                                        <i
                                            class="fas fa-mobile-alt text-2xl text-gray-400 peer-checked:text-primary"></i>
                                        <span
                                            class="text-sm font-medium text-gray-600 peer-checked:text-primary">UPI</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer relative group">
                                    <input type="radio" name="payment_method" value="netbanking"
                                        class="peer absolute opacity-0">
                                    <div
                                        class="p-4 rounded-xl border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-red-50 transition-all flex flex-col items-center justify-center gap-2 h-full group-hover:border-gray-300">
                                        <i
                                            class="fas fa-university text-2xl text-gray-400 peer-checked:text-primary"></i>
                                        <span class="text-sm font-medium text-gray-600 peer-checked:text-primary">Net
                                            Banking</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div id="payment-details-container" class="bg-gray-50 rounded-xl p-6 border border-gray-100">
                            <div id="card-details" class="payment-section space-y-6">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2 text-lg">Card Number</label>
                                    <div class="relative">
                                        <input type="text" id="card-input" placeholder="0000 0000 0000 0000"
                                            maxlength="19"
                                            class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors font-mono">
                                        <i id="card-icon"
                                            class="fas fa-credit-card absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl"></i>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="block text-gray-700 font-medium mb-2 text-lg">Expiry Date</label>
                                        <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5"
                                            class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors text-center font-mono">
                                    </div>
                                    <div class="form-group">
                                        <label class="block text-gray-700 font-medium mb-2 text-lg">CVV</label>
                                        <input type="password" id="card-cvv" placeholder="123" maxlength="3"
                                            class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors text-center font-mono">
                                    </div>
                                </div>
                            </div>
                            <div id="upi-details" class="payment-section hidden space-y-6">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2 text-lg">UPI ID</label>
                                    <input type="text" placeholder="username@bank"
                                        class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                                    <p class="text-sm text-gray-500 mt-2">Verify your UPI ID on your mobile app.</p>
                                </div>
                            </div>
                            <div id="netbanking-details" class="payment-section hidden space-y-6">
                                <div class="form-group">
                                    <label class="block text-gray-700 font-medium mb-2 text-lg">Select Bank</label>
                                    <select
                                        class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                                        <option>HDFC Bank</option>
                                        <option>ICICI Bank</option>
                                        <option>SBI</option>
                                        <option>Axis Bank</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-8 border-t border-gray-100">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Security Verification</h3>
                            <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                                <div class="flex items-center gap-4">
                                    <div id="captcha-container"
                                        class="bg-gray-100 rounded-xl overflow-hidden h-[60px] w-[180px] flex items-center justify-center border border-gray-200">
                                    </div>
                                    <button type="button" id="refresh-captcha"
                                        class="text-primary hover:text-red-700 transition-colors p-3 bg-red-50 rounded-full">
                                        <i class="fas fa-sync-alt text-xl"></i>
                                    </button>
                                </div>
                                <div class="flex-1 w-full">
                                    <input type="text" id="booking-captcha" placeholder="Enter security code" required
                                        class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                                    <input type="hidden" id="booking-captcha-id">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full bg-primary hover:bg-red-700 text-white font-bold py-5 px-8 rounded-xl text-xl shadow-xl transform transition hover:-translate-y-1 flex items-center justify-center gap-3">
                        <span class="btn-text">Confirm & Pay</span>
                        <div
                            class="spinner hidden w-6 h-6 border-4 border-white border-t-transparent rounded-full animate-spin">
                        </div>
                    </button>
                </form>
            </div>

            <div class="lg:col-span-1">
                <div class="summary-card bg-white rounded-2xl shadow-lg border border-gray-100 p-6 sticky top-28">
                    <h3 class="font-serif text-xl font-bold text-gray-900 mb-6 pb-4 border-b border-gray-100">Trip
                        Summary</h3>
                    <div id="flight-loading" class="text-center py-8 text-gray-500">
                        <div
                            class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-3">
                        </div>
                        Loading flight details...
                    </div>
                    <div id="flight-details" class="hidden space-y-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Route</div>
                                <div class="text-2xl font-bold text-primary" id="summary-route"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Availability
                                </div>
                                <div class="text-sm font-bold text-green-500 bg-green-50 px-3 py-1 rounded-full"
                                    id="seats-available">-- Seats</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Date</div>
                                <div class="font-medium text-gray-900" id="summary-date"></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Flight</div>
                                <div class="font-medium text-gray-900" id="summary-airline"></div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                            <div class="font-bold text-secondary mb-3 flex items-center gap-2">
                                <i class="fas fa-crown"></i>Membership Rewards
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="membership-input" placeholder="Enter Member ID"
                                    class="flex-1 p-2 text-sm border border-yellow-200 rounded-lg focus:border-secondary focus:outline-none">
                                <button type="button" id="redeem-btn"
                                    class="bg-secondary text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-700 transition-colors">Apply</button>
                            </div>
                            <div id="discount-msg" class="mt-2 text-xs font-bold hidden"></div>
                        </div>

                        <div class="pt-6 border-t border-gray-100 space-y-3">
                            <div class="flex justify-between text-gray-500">
                                <span>Base Fare</span>
                                <span id="price-breakdown-base" class="font-mono text-gray-900">$0.00</span>
                            </div>
                            <div class="flex justify-between text-gray-500">
                                <span>Taxes & Fees (10%)</span>
                                <span id="price-breakdown-tax" class="font-mono text-gray-900">$0.00</span>
                            </div>
                            <div id="price-breakdown-discount-row" class="flex justify-between text-green-600 hidden">
                                <span>Membership Discount</span>
                                <span id="price-breakdown-discount" class="font-mono">-$0.00</span>
                            </div>
                            <div
                                class="flex justify-between items-end pt-4 mt-2 border-t border-dashed border-gray-200">
                                <span class="text-lg font-bold text-gray-900">Total</span>
                                <span id="summary-total" class="text-3xl font-bold text-primary font-mono">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="notification-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeNotification()"></div>
        <div
            class="relative bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all modal-animate">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-info-circle text-3xl text-blue-500"></i>
                </div>
                <h3 id="notification-title" class="text-xl font-bold text-gray-900 mb-2">Notification</h3>
                <p id="notification-message" class="text-gray-600 mb-6">Message goes here</p>
                <button onclick="closeNotification()"
                    class="w-full bg-gray-900 text-white font-bold py-3 rounded-xl hover:bg-black transition-colors">Okay,
                    Got it</button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm"></div>
        <div
            class="relative bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all scale-100 success-modal-content">
            <div class="bg-green-50 p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-600"></div>
                <div
                    class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg success-icon-circle">
                    <i class="fas fa-check text-4xl text-green-600"></i>
                </div>
                <h2 class="font-serif text-3xl font-bold text-gray-900 mb-2">Booking Confirmed</h2>
                <p class="text-gray-500">Your flight has been successfully booked.</p>
            </div>
            <div class="p-8">
                <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100 mb-6 space-y-4">
                    <div class="flex justify-between items-center pb-4 border-b border-dashed border-gray-200">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">PNR Code</span>
                        <span id="modal-pnr" class="text-2xl font-mono font-bold text-primary tracking-widest"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Transaction ID</span>
                        <span id="modal-txn"
                            class="text-sm font-mono text-gray-600 bg-white px-2 py-1 rounded border border-gray-200"></span>
                    </div>
                </div>
                <button id="modal-close-btn"
                    class="w-full bg-primary hover:bg-red-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg transition-all">View
                    My Trips</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const pathParts = window.location.pathname.split('/');
            let flightId = pathParts[pathParts.length - 1];
            if (!flightId) flightId = pathParts[pathParts.length - 2];

            console.log("Booking Flight ID:", flightId);
            const userStr = localStorage.getItem('user');

            if (!userStr) {
                window.location.href = '/login/';
                return;
            }

            const user = JSON.parse(userStr);

            let basePrice = 0;
            const taxRate = 0.10;
            let flightDetails = null;
            let seatMapData = null;

            let passengerSeatAssignments = {};
            let passengerReturnSeatAssignments = {};
            let isSelectingReturnSeats = false;

            const passengersContainer = document.getElementById('passengers-container');
            const addPassengerBtn = document.getElementById('add-passenger-btn');
            const confirmPassengersBtn = document.getElementById('confirm-passengers-btn');
            const confirmSeatsBtn = document.getElementById('confirm-seats-btn');

            const flightOptionsSection = document.getElementById('flight-options-section');
            const passengersSection = document.getElementById('passengers-section');
            const seatSelectionSection = document.getElementById('seat-selection-section');
            const paymentSection = document.getElementById('payment-section');

            addPassengerForm();

            async function loadCaptcha() {
                try {
                    const res = await fetch('/api/flights/auth/captcha/');
                    const data = await res.json();
                    const container = document.getElementById('captcha-container');

                    if (container) {
                        container.innerHTML = data.svg;
                        document.getElementById('booking-captcha-id').value = data.captcha_id;
                    }
                } catch (e) {
                    console.error("Failed to load captcha", e);
                }
            }

            loadCaptcha();
            document.getElementById('refresh-captcha').addEventListener('click', loadCaptcha);

            try {
                const [flightResponse, seatMapResponse] = await Promise.all([
                    fetch(`/api/flights/${flightId}/`),
                    fetch(`/api/flights/${flightId}/seatmap/`)
                ]);

                if (!flightResponse.ok) {
                    const errText = await flightResponse.text();
                    throw new Error(`Failed to fetch flight details: ${flightResponse.status} ${errText}`);
                }

                flightDetails = await flightResponse.json();

                if (seatMapResponse.ok) {
                    seatMapData = await seatMapResponse.json();
                } else {
                    console.error("Could not load seat map data on initial load");
                }

                document.getElementById('flight-loading').classList.add('hidden');
                document.getElementById('flight-details').classList.remove('hidden');

                document.getElementById('summary-route').textContent = `${flightDetails.origin} → ${flightDetails.destination}`;

                const date = new Date(flightDetails.departure_time);

                document.getElementById('summary-date').textContent = date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                document.getElementById('summary-airline').textContent = `${flightDetails.airline_code} • ${flightDetails.flight_number}`;

                basePrice = parseFloat(flightDetails.base_price);
                updatePrice();

            } catch (err) {
                console.error(err);

                document.getElementById('flight-loading').innerHTML = `<div class="text-red-500" ><i class="fas fa-exclamation-circle text-3xl mb-2" ></i><br> Could not load flight details.<br> <span class="text-sm opacity-75" >${err.message}</span></div>`;
            }

            addPassengerBtn.addEventListener('click', () => {
                addPassengerForm();
                updatePrice();
            });

            confirmPassengersBtn.addEventListener('click', async () => {
                passengersSection.classList.add('hidden');
                seatSelectionSection.classList.remove('hidden');
                document.querySelector('[data-step="passengers"]').classList.remove('step-active');
                document.querySelector('[data-step="seats"]').classList.add('step-active');
                renderSeatMap();
            });

            confirmSeatsBtn.addEventListener('click', () => {
                const totalPassengers = passengersContainer.children.length;
                const isRoundTrip = document.querySelector('input[name="trip_type"]:checked').value === 'round_trip';

                if (!isSelectingReturnSeats) {
                    if (Object.keys(passengerSeatAssignments).length < totalPassengers) {
                        showNotification('Selection Incomplete', 'Please select an outbound seat for each passenger.');
                        return;
                    }

                    if (isRoundTrip) {
                        isSelectingReturnSeats = true;
                        showNotification('Outbound Confirmed', 'Outbound seats confirmed. Now please select your RETURN seats.');
                        document.querySelectorAll('.seat.selected').forEach(el => el.classList.remove('selected'));
                        renderSeatMap();
                        return;
                    }
                } else {
                    if (Object.keys(passengerReturnSeatAssignments).length < totalPassengers) {
                        showNotification('Selection Incomplete', 'Please select a return seat for each passenger.');
                        return;
                    }
                }

                document.querySelector('[data-step="seats"]').classList.remove('step-active');
                document.querySelector('[data-step="payment"]').classList.add('step-active');

                seatSelectionSection.classList.add('hidden');
                paymentSection.classList.remove('hidden');
            });

            const travelClassSelect = document.getElementById('travel-class');
            const tripTypeInputs = document.querySelectorAll('input[name="trip_type"]');
            const returnDateContainer = document.getElementById('return-date-container');
            const returnDateInput = document.getElementById('return-date');

            travelClassSelect.addEventListener('change', () => {
                updatePrice();

                if (!seatSelectionSection.classList.contains('hidden')) {
                    renderSeatMap();
                }
            });

            tripTypeInputs.forEach(input => {
                input.addEventListener('change', () => {
                    const returnInputs = document.querySelectorAll('.return-seat-input');

                    if (input.value === 'round_trip') {
                        returnDateContainer.classList.remove('hidden');
                        returnDateInput.setAttribute('required', 'required');
                        returnInputs.forEach(el => el.classList.remove('hidden'));
                    } else {
                        returnDateContainer.classList.add('hidden');
                        returnDateInput.removeAttribute('required');
                        returnDateInput.value = '';
                        returnInputs.forEach(el => el.classList.add('hidden'));
                    }

                    updatePrice();
                });
            });

            function addPassengerForm() {
                const count = passengersContainer.children.length + 1;
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-xl p-6 border border-gray-100 relative group';
                div.dataset.passengerId = count;

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-gray-900 flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs">${count}</div>
                            Passenger ${count}
                        </h4>
                        ${count > 1 ? `<button type="button" class="remove-btn text-red-500 hover:text-red-700 text-sm font-medium transition-colors"><i class="fas fa-trash-alt mr-1"></i> Remove</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group md:col-span-2">
                            <label class="block text-gray-700 font-medium mb-2">Full Name</label>
                            <input type="text" name="name_${count}" required placeholder="e.g. John Doe" class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 font-medium mb-2">Age</label>
                            <input type="number" name="age_${count}" required min="1" max="120" class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 font-medium mb-2">Phone</label>
                            <input type="tel" name="phone_${count}" required placeholder="+1 234 567 890" class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                        </div>
                        <div class="form-group md:col-span-2">
                            <label class="block text-gray-700 font-medium mb-2">Email</label>
                            <input type="email" name="email_${count}" required placeholder="john@example.com" class="w-full p-4 text-lg bg-white border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 font-medium mb-2">Assigned Seat</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" name="seat_number_${count}" readonly placeholder="Outbound" class="w-full p-4 text-lg bg-gray-200 border-2 border-gray-300 rounded-xl focus:outline-none transition-colors text-center font-mono">
                                <input type="text" name="return_seat_number_${count}" readonly placeholder="Return" class="w-full p-4 text-lg bg-gray-200 border-2 border-gray-300 rounded-xl focus:outline-none transition-colors text-center font-mono hidden return-seat-input">
                            </div>
                        </div>
                    </div>`;

                passengersContainer.appendChild(div);

                if (count > 1) {
                    const removeBtn = div.querySelector('.remove-btn');
                    removeBtn.addEventListener('click', () => {
                        div.remove();
                        updatePassengerNumbers();
                        updatePrice();
                    });
                }
            }

            function updatePassengerNumbers() {
                Array.from(passengersContainer.children).forEach((div, index) => {
                    const count = index + 1;
                    div.dataset.passengerId = count;
                    div.querySelector('h4').innerHTML = `<div class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs">${count}</div> Passenger ${count}`;

                    div.querySelectorAll('input, select').forEach(input => {
                        const name = input.name.split('_')[0];
                        input.name = `${name}_${count}`;
                    });
                });
            }

            const redeemBtn = document.getElementById('redeem-btn');
            const membershipInput = document.getElementById('membership-input');
            const discountMsg = document.getElementById('discount-msg');
            let discountApplied = false;

            if (redeemBtn) {
                redeemBtn.addEventListener('click', () => {
                    const inputId = membershipInput.value.trim();
                    const userMemId = user.membership_id;

                    if (!inputId) {
                        alert('Please enter a membership ID.');
                        return;
                    }

                    if (inputId === userMemId) {
                        if (discountApplied) {
                            alert('Discount already applied.');
                            return;
                        }

                        discountApplied = true;
                        discountMsg.textContent = 'Membership verified! 10% discount applied.';
                        discountMsg.className = 'mt-2 text-xs font-bold text-green-600';
                        discountMsg.style.display = 'block';
                        redeemBtn.disabled = true;
                        redeemBtn.textContent = 'Applied';
                        redeemBtn.className = 'bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold cursor-default';
                        updatePrice();
                    } else {
                        discountMsg.textContent = 'Invalid Membership ID.';
                        discountMsg.className = 'mt-2 text-xs font-bold text-red-500';
                        discountMsg.style.display = 'block';
                    }
                });
            }

            function updatePrice() {
                const count = passengersContainer.children.length;
                let multiplier = 1;
                let seatsDisplay = 0;
                const travelClass = document.getElementById('travel-class').value;

                if (seatMapData && seatMapData.seat_map) {
                    seatsDisplay = seatMapData.seat_map.flat().filter(seat => seat.seat_class === travelClass && !seat.is_occupied).length;
                } else if (flightDetails) {
                    seatsDisplay = flightDetails.available_seats;
                    if (travelClass === 'Business') {
                        seatsDisplay = Math.floor(flightDetails.available_seats * 0.25);
                    }
                    if (travelClass === 'First') {
                        seatsDisplay = Math.floor(flightDetails.available_seats * 0.10);
                    }
                }

                if (travelClass === 'Business') {
                    multiplier = 1.5;
                }
                if (travelClass === 'First') {
                    multiplier = 2.5;
                }

                const isRoundTrip = document.querySelector('input[name="trip_type"]:checked').value === 'round_trip';
                if (isRoundTrip) {
                    multiplier *= 2;
                }

                const seatsEl = document.getElementById('seats-available');
                if (seatsEl) {
                    seatsEl.textContent = `${seatsDisplay} Seats`;
                    if (seatsDisplay < 5) {
                        seatsEl.className = 'text-sm font-bold text-red-500 bg-red-50 px-3 py-1 rounded-full';
                    } else {
                        seatsEl.className = 'text-sm font-bold text-green-500 bg-green-50 px-3 py-1 rounded-full';
                    }
                }

                let subtotal = basePrice * multiplier * count;
                let discountAmount = 0;

                if (discountApplied) {
                    discountAmount = subtotal * 0.1;
                    subtotal = subtotal - discountAmount;
                }

                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                document.getElementById('price-breakdown-base').textContent = `$${(basePrice * multiplier * count).toFixed(2)}`;
                document.getElementById('price-breakdown-tax').textContent = `$${tax.toFixed(2)}`;
                document.getElementById('summary-total').textContent = `$${total.toFixed(2)}`;

                if (discountApplied) {
                    document.getElementById('price-breakdown-discount-row').classList.remove('hidden');
                    document.getElementById('price-breakdown-discount-row').classList.add('flex');
                    document.getElementById('price-breakdown-discount').textContent = `-$${discountAmount.toFixed(2)}`;
                }
            }

            function showNotification(title, message) {
                let modal = document.getElementById('notification-modal');
                if (!modal) {
                    alert(`${title}: ${message}`);
                    return;
                }
                document.getElementById('notification-title').textContent = title;
                document.getElementById('notification-message').textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            window.closeNotification = function () {
                const modal = document.getElementById('notification-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }

            function showSuccessModal(bookingId) {
                const modal = document.getElementById('success-modal');
                if (modal) {
                    const refEl = document.getElementById('modal-pnr');
                    if (refEl) refEl.textContent = bookingId;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');

                    if (typeof confetti === 'function') {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                }
            }

            function renderSeatMap() {
                const container = document.getElementById('seat-map-container');
                if (!container) return;
                container.innerHTML = '';

                if (!seatMapData || !seatMapData.seat_map) return;

                const rows = seatMapData.seat_map;
                const selectedTravelClass = document.getElementById('travel-class').value;
                const selectedTravelClassLower = selectedTravelClass.toLowerCase();

                rows.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'seat-row mb-2';

                    row.forEach((seat, index) => {
                        if (index === 3) {
                            const aisle = document.createElement('div');
                            aisle.className = 'aisle';
                            rowDiv.appendChild(aisle);
                        }

                        const seatDiv = document.createElement('div');
                        let seatClass = 'seat';

                        if (seat.is_occupied) {
                            seatClass += ' occupied';
                        } else if (seat.seat_class.toLowerCase() !== selectedTravelClassLower) {
                            seatClass += ' disabled';
                        } else {
                            const currentAssignments = isSelectingReturnSeats ? passengerReturnSeatAssignments : passengerSeatAssignments;
                            if (Object.values(currentAssignments).includes(seat.seat_number)) {
                                seatClass += ' selected';
                            }
                        }

                        seatDiv.className = seatClass;
                        seatDiv.textContent = seat.seat_number;
                        seatDiv.dataset.seatNumber = seat.seat_number;
                        seatDiv.dataset.seatClass = seat.seat_class;
                        seatDiv.addEventListener('click', handleSeatSelection);
                        rowDiv.appendChild(seatDiv);
                    });

                    container.appendChild(rowDiv);
                });
            }

            function handleSeatSelection(event) {
                const seatEl = event.target;
                const seatNumber = seatEl.dataset.seatNumber;
                const seatClass = seatEl.dataset.seatClass;
                const selectedTravelClass = document.getElementById('travel-class').value.toLowerCase();

                if (seatEl.classList.contains('occupied') || seatEl.classList.contains('disabled')) return;
                if (seatClass.toLowerCase() !== selectedTravelClass) return;

                const totalPassengers = passengersContainer.children.length;
                const currentAssignments = isSelectingReturnSeats ? passengerReturnSeatAssignments : passengerSeatAssignments;
                const inputNamePrefix = isSelectingReturnSeats ? 'return_seat_number_' : 'seat_number_';

                if (seatEl.classList.contains('selected')) {
                    seatEl.classList.remove('selected');
                    for (const [passengerId, assignedSeat] of Object.entries(currentAssignments)) {
                        if (assignedSeat === seatNumber) {
                            delete currentAssignments[passengerId];
                            const input = document.querySelector(`input[name="${inputNamePrefix}${passengerId}"]`);
                            if (input) input.value = '';
                            break;
                        }
                    }
                } else {
                    if (Object.keys(currentAssignments).length >= totalPassengers) {
                        showNotification('Selection Incomplete', isSelectingReturnSeats ? 'Please select a return seat for each passenger.' : 'Please select an outbound seat for each passenger.');
                        return;
                    }

                    for (let i = 1; i <= totalPassengers; i++) {
                        if (!currentAssignments[i]) {
                            currentAssignments[i] = seatNumber;
                            seatEl.classList.add('selected');
                            const input = document.querySelector(`input[name="${inputNamePrefix}${i}"]`);
                            if (input) input.value = seatNumber;
                            break;
                        }
                    }
                }
            }

            const form = document.getElementById('booking-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]');
                const spinner = btn.querySelector('.spinner');
                const btnText = btn.querySelector('.btn-text');
                const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

                if (paymentMethod === 'card') {
                    if (!document.getElementById('card-input').value || !document.getElementById('card-expiry').value || !document.getElementById('card-cvv').value) {
                        alert('Please fill in all card details.');
                        return;
                    }
                } else if (paymentMethod === 'upi') {
                    if (!document.querySelector('#upi-details input').value) {
                        alert('Please enter your UPI ID.');
                        return;
                    }
                } else if (paymentMethod === 'netbanking') {
                    if (!document.querySelector('#netbanking-details select').value) {
                        alert('Please select a bank.');
                        return;
                    }
                }

                btn.disabled = true;
                btnText.textContent = 'Processing...';
                spinner.classList.remove('hidden');

                await new Promise(r => setTimeout(r, 1500));
                const passengers = [];

                Array.from(passengersContainer.children).forEach((div, index) => {
                    const inputs = div.querySelectorAll('input, select');
                    let p = {};
                    const passengerId = index + 1;

                    inputs.forEach(input => {
                        if (input.name.startsWith('name')) p.name = input.value;
                        if (input.name.startsWith('age')) p.age = input.value;
                        if (input.name.startsWith('email')) p.email = input.value;
                        if (input.name.startsWith('phone')) p.phone = input.value;
                        if (input.name.startsWith('seat_number')) p.seat_number = input.value;
                        if (input.name.startsWith('return_seat_number')) p.return_seat_number = input.value;
                    });
                    passengers.push(p);
                });

                try {
                    if (!flightDetails) throw new Error("Flight details not loaded.");

                    const bookResponse = await fetch('/api/flights/bookings/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            trip_type: document.querySelector('input[name="trip_type"]:checked').value,
                            return_date: document.getElementById('return-date').value,
                            user_email: user.email,
                            flight_number: flightDetails.flight_number,
                            flight_id: flightId,
                            passenger_details: passengers,
                            travel_class: document.getElementById('travel-class').value,
                            payment_method: document.querySelector('input[name="payment_method"]:checked').value,
                            payment_details: getPaymentDetails(),
                            captcha_id: document.getElementById('booking-captcha-id').value,
                            captcha_value: document.getElementById('booking-captcha').value
                        })
                    });

                    const result = await bookResponse.json();

                    if (bookResponse.ok) {
                        showSuccessModal(result.booking.booking_reference);
                        document.getElementById('modal-txn').textContent = result.booking.transaction_id;

                        document.getElementById('modal-close-btn').addEventListener('click', () => {
                            window.location.href = '/my-trips/';
                        });
                    } else {
                        alert(result.error || 'Booking failed');
                        btn.disabled = false;
                        btnText.textContent = 'Confirm & Pay';
                        spinner.classList.add('hidden');
                        loadCaptcha();
                    }
                } catch (err) {
                    console.error(err);
                    alert('An error occurred: ' + err.message);
                    btn.disabled = false;
                    btnText.textContent = 'Confirm & Pay';
                    spinner.classList.add('hidden');
                }
            });

            const cardInput = document.getElementById('card-input');
            const cardIcon = document.getElementById('card-icon');

            if (cardInput) {
                cardInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    let formattedValue = '';

                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) formattedValue += ' ';
                        formattedValue += value[i];
                    }

                    e.target.value = formattedValue;
                    cardIcon.className = 'fas fa-credit-card absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl';

                    if (value.startsWith('4')) {
                        cardIcon.className = 'fab fa-cc-visa absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-600 text-xl';
                    } else if (value.startsWith('5')) {
                        cardIcon.className = 'fab fa-cc-mastercard absolute right-4 top-1/2 transform -translate-y-1/2 text-orange-500 text-xl';
                    } else if (value.startsWith('3')) {
                        cardIcon.className = 'fab fa-cc-amex absolute right-4 top-1/2 transform -translate-y-1/2 text-blue-400 text-xl';
                    } else if (value.startsWith('6')) {
                        cardIcon.className = 'fab fa-cc-discover absolute right-4 top-1/2 transform -translate-y-1/2 text-orange-600 text-xl';
                    }
                });
            }

            const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
            const paymentSections = document.querySelectorAll('.payment-section');

            paymentRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const method = e.target.value;
                    paymentSections.forEach(section => section.classList.add('hidden'));

                    const selectedSection = document.getElementById(`${method}-details`);
                    if (selectedSection) selectedSection.classList.remove('hidden');
                });
            });
        });

        function getPaymentDetails() {
            const method = document.querySelector('input[name="payment_method"]:checked').value;

            if (method === 'card') {
                const cardNum = document.getElementById('card-input').value;
                return cardNum ? `**** ${cardNum.slice(-4)}` : '';
            } else if (method === 'upi') {
                return document.querySelector('#upi-details input').value;
            } else if (method === 'netbanking') {
                return document.querySelector('#netbanking-details select').value;
            }

            return '';
        }
    </script>
</body>

</html>